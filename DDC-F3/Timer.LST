C51 COMPILER V9.51   TIMER                                                                 03/26/2014 20:06:26 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE TIMER
OBJECT MODULE PLACED IN Timer.OBJ
COMPILER INVOKED BY: D:\Program Files (x86)\keil\C51\BIN\C51.EXE Timer.c ROM(COMPACT) BROWSE DEBUG OBJECTEXTEND TABS(3)

line level    source

   1          /*---------------------------------------------------
   2             Timer.c (v1.00)
   3             
   4             Timer functions
   5          ---------------------------------------------------*/ 
   6          
   7          #include "main.h"
   8          #include "port.h"
   9          
  10          #include "Timer.h"
  11          #include "communication.h"
  12          #include "Other.h"
  13          #include "voice.h"
  14          #include "AD.h"
  15          #include "delay.h"
  16          
  17          // ------ Public variable declarations -----------------------------
  18          bit fell_alarm_flag = 0;         //µ¹µØ±¨¾¯±êÖ¾
  19          tByte fell_alarm_count = 0;      //µ¹µØ±¨¾¯Ñ­»·´ÎÊý
  20          
  21          bit raised_alarm_flag = 0;    //Ì§Æð±¨¾¯±êÖ¾
  22          tByte raised_alarm_count = 0; //Ì§Æð±¨¾¯Ñ­»·´ÎÊý
  23          
  24          bit stolen_alarm_flag = 0;    //±»µÁ±¨¾¯±êÖ¾
  25          tWord stolen_alarm_count = 0; //±»µÁ±¨¾¯Ñ­»·´ÎÊý
  26          
  27          bit transmit_comm1_flag = 0;     //Ã¿¸ôÒ»¶ÎÊ±¼ä½«ÆäÖÃ1£¬ÔòÔÚmainº¯ÊýÖÐ·¢ÉäÊý¾Ý£¬¾Í²»»áÓ°Ïìtimer0µÄ¼ÆÊ±£¬·¢ÉäÍ
             -êºó½«ÆäÖÃ0.
  28          bit battery_check = 0;           //ÖÃ1Ê±£¬Ö´ÐÐÒ»´ÎµçÁ¿×ª»»£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  29          bit Host_battery_high_flag = 0;     //ÖÃ1Ê±£¬Ö´ÐÐÒ»´ÎÓïÒôÌáÊ¾£¬±íÊ¾³äµçÒÑÂú
  30          
  31          extern tWord ADC_check_result;      //×÷ÎªAD¼ì²âÖµ
  32          extern bit battery_HV_flag;         //µç³ØµçÎ»µÄ±ê¼Ç£¬1±íÊ¾ÏÖÔÚµç³ØÊÇÂúµÄ£¬0±íÊ¾»¹Ã»Âú¡£
  33          
  34          
  35          // ------ Private variable definitions -----------------------------
  36          tByte timer0_8H, timer0_8L, timer1_8H, timer1_8L;  //¶¨Ê±Æ÷0ºÍ1µÄ¶¨Ê±Êý¾Ý
  37          
  38          tWord timer0_count = 0;       //ÓÃÀ´¼ÆÊýtimer0µÄ´ÎÊý£¬Ã»Òç³öÒ»´Î¾Í¼Ó1£¬Ïàµ±ÓÚ¼ÆÊ±
  39          tByte leave_count = 0;           //Ã¿¸ô3s¼Ó1£¬Èç¹ûÖ÷»úÓ¦´ðÕýÈ·£¬Ôò½«ÆäÇåÁã
  40          tByte received_data_buffer[7] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00};   //½ÓÊÕÊý¾Ý»º´æ
  41          bit receive_data_finished_flag = 0;    //½ÓÊÕÕâÒ»´®Êý¾ÝÍê³Éºó£¬´Ë±êÖ¾Î»ÖÃ1
  42          tByte data_count = 0;            //½ÓÊÕÊý¾Ý»º´æµÄÎ»Êý£¬¼´±íÃ÷µÚ¼¸¸ö»º´æÊý¾Ý
  43          tByte one_receive_byte = 0;      //½ÓÊÕÊý¾ÝµÄÒ»¸ö×Ö½Ú£¬½ÓÊÕÍêºó½«Æä¸³Öµ¸øreceived_data_bufferÏà¶ÔÓ¦µÄ×Ö½Ú
  44          tByte one_receive_byte_count = 0;         //one_receive_byteÓÐ8Î»£¬´Ë¼ÆÊý±íÃ÷½ÓÊÕµ½µÚ¼¸Î»£¬Ã¿´Î¼ÆÊýµ½8µÄÊ±ºò±íÃ÷
             -Ò»¸ö×Ö½Ú½ÓÊÕÍê³É¡£
  45          bit receive_wire_flag = 1;    //½ÓÊÕÍ¨ÐÅÏßµÄ±êÖ¾Î»£¬1±íÃ÷¸ßµçÆ½£¬0±íÃ÷µÍµçÆ½£¬Ã¿´Îtimer1Òç³öÊ±£¬ÅÐ¶ÏP1.1Ò»´Î
             -¡£ÒÔ´ËÀ´±íÃ÷ÊÇ·ñÎªÒ»´ÎÕýÈ·µÄÏÂ½µÑØ
  46          tByte receive_HV_count = 0;      //¶¨Ê±Æ÷T1ÔÚÃ»ÓÐÐÅºÅµ½À´µÄÊ±ºò£¬¶Ô¸ßµçÆ½¼ÆÊý£¬Ò»µ©³¬¹ýÄ³¸öÖµ£¬Ôò½«one_receive
             -_byte_countÇå0
  47          tByte receive_LV_count = 0;      //Ã¿´Îtimer1Òç³öÊ±ÅÐ¶Ï½ÓÊÕÏßÈç¹ûÎªLV£¬Ôò¼ÆÊý¼Ó1£¬ÒÔ´ËÀ´±íÃ÷µÍµçÆ½µÄÊ±¼ä
  48          bit battery_stolen_EN = 0;       // ×÷Îª¸½»ú½Óµ½µç³Ø±»µÁÐÅºÅºó£¬±¨¾¯µÄÊ¹ÄÜ
  49          
  50          /*------------------------------------------------------------------
  51             timerT0()
C51 COMPILER V9.51   TIMER                                                                 03/26/2014 20:06:26 PAGE 2   

  52             ¶¨Ê±Æ÷0Ã¿´ÎÒç³öºóÖ´ÐÐµÄ²Ù×÷
  53          --------------------------------------------------------------------*/
  54          
  55          void timer0() interrupt interrupt_timer_0_overflow
  56             {
  57   1         // ÖØ×°ÔÚ¶¨Ê±Æ÷µÄÊ±¼äÉèÖÃ
  58   1         TH0 = timer0_8H;
  59   1         TL0 = timer0_8L;
  60   1      
  61   1         // ÉèÖÃÒ»¸öÃ¿3sµÄ²Ù×÷
  62   1         if(++timer0_count >= 60)      
  63   1            {
  64   2            // Ã¿¸ö3s×öÒ»´ÎµçÁ¿¼ì²â£¬²¢½øÐÐÏà¹ØµÄµçÁ¿ÌáÊ¾
  65   2            ADC_check_result = GetADCResult(6);
  66   2            
  67   2      
  68   2            
  69   2            // ÅÐ¶Ïµç³ØµçÑ¹£¬Èç¹ûÐ¡ÓÚ3.4VÇÒÔ­ÏÈ±¨¹ý¸ßµçÑ¹Ê±£¬Ôò±¨µçÁ¿²»×ã¡£Èç¹ûµçÑ¹´óÓÚ4.2VÇÒÓëÔ­ÏÈ±¨¹ýµçÁ¿²»×ãÊ±£¬Ô
             -òÌáÊ¾µçÑ¹¹ý¸ß
  70   2            if((battery_HV_flag == 1)&&(ADC_check_result <= 0x333))
  71   2               {
  72   3               // ´ËÎ»ÖÃ0£¬±íÊ¾µçÁ¿¹ýµÍ
  73   3               battery_HV_flag = 0;
  74   3               Battery_low_alarm_speech();      
  75   3               }
  76   2            else if((battery_HV_flag == 0)&&(ADC_check_result >= 0x35a))
  77   2               {
  78   3               // ´ËÎ»ÖÃ1£¬±íÊ¾µçÁ¿¹ý¸ß
  79   3               battery_HV_flag = 1;
  80   3               Battery_high_alarm_speech();
  81   3               }  
  82   2      
  83   2            // ½«¼ÆÊýÇå0
  84   2            timer0_count = 0;
  85   2      //    battery_stolen_EN = 1;
  86   2            }
  87   1      
  88   1         // Ö÷»ú±»µÁ±¨¾¯
  89   1         if(stolen_alarm_flag == 1)    
  90   1            {
  91   2            // Ö÷»ú±»µÁ±¨¾¯´ÎÊý£¬Ã¿±¨Ò»´Î¼Ó1£¬Èç¹û´óÓÚ2´Î£¬Ôò¼ÌÐø¼Ó1£¬µ½Ò»¶¨Ê±¼äºó£¬½«flagºÍcountÇå0.ÒÔ´ËÀ´±£Ö¤¸½»úÃ
             -¿´Î±¨¾¯ºó£¬ÔÚ¶ÌÊ±¼äÄÚ
  92   2            // ÔÙ´ÎÊÕµ½±¨¾¯ÐÅºÅ£¬¾Í²»»á±¨¾¯ÁË¡£
  93   2            if(++stolen_alarm_count < 3)
  94   2               {        
  95   3               // ÓïÒôÌáÊ¾£¬Âí´ïÕñ¶¯
  96   3               Alarm_stolen_speech();     
  97   3               Moto_Vibration();          
  98   3               }
  99   2            else
 100   2               {
 101   3               if(stolen_alarm_count >= 1200)
 102   3                  {
 103   4                  stolen_alarm_count = 0;
 104   4                  stolen_alarm_flag = 0;
 105   4                  }
 106   3               }
 107   2            }  
 108   1      
 109   1         // Ì§ÆðÐÅºÅ±¨¾¯£¬Ã¿´Î±¨ÍêºóÇå0£¬Èç¹ûÔÙ´Î½Óµ½Ôò¼ÌÐø±¨¡£Ò»°ãÀ´Ëµ£¬Ö÷»úÃ¿´ÎÌ§ÆðÖ»·¢4±é¡£
 110   1         if(raised_alarm_flag == 1) 
 111   1            {
C51 COMPILER V9.51   TIMER                                                                 03/26/2014 20:06:26 PAGE 3   

 112   2            Alarm_raised_speech();     
 113   2            Moto_Vibration();         
 114   2            raised_alarm_flag = 0;
 115   2            }
 116   1      
 117   1         // µ¹µØÐÅºÅ±¨¾¯£¬Ã¿´Î±¨ÍêºóÇå0£¬Èç¹ûÔÙ´Î½Óµ½Ôò¼ÌÐø±¨¡£Ò»°ãÀ´Ëµ£¬Ö÷»úÃ¿´Îµ¹µØÖ»·¢4±é¡£
 118   1         if(fell_alarm_flag == 1)
 119   1            {
 120   2            Alarm_fell_speech();      
 121   2            Moto_Vibration();         
 122   2            fell_alarm_flag=0;
 123   2            }
 124   1      
 125   1         // Ö÷»úµçÁ¿³äÂúÌáÊ¾
 126   1         if(Host_battery_high_flag == 1)
 127   1            {
 128   2            Host_battery_high_alarm_speech();      
 129   2            Host_battery_high_flag = 0;
 130   2            }
 131   1            
 132   1         if(battery_stolen_EN == 1)
 133   1            {
 134   2            battery_stolen_speech();
 135   2            battery_stolen_EN = 0;
 136   2            }
 137   1         }
 138          
 139          /*------------------------------------------------------------------
 140             timerT1()
 141             ¶¨Ê±Æ÷1Ã¿´ÎÒç³öºóÖ´ÐÐµÄ²Ù×÷
 142          --------------------------------------------------------------------*/
 143             
 144          void timerT1() interrupt interrupt_timer_1_overflow         
 145             {
 146   1         // ÖØ×°ÔÚ¶¨Ê±Æ÷1µÄÉèÖÃ
 147   1         TH1 = timer1_8H;           
 148   1         TL1 = timer1_8L;
 149   1      
 150   1         // ÅÐ¶Ï½ÓÊÕÏßÊÇ·ñÎª0£¬Èç¹ûÊÇ0£¬Ôò±íÊ¾¿ÉÄÜÓÐÐÅºÅ¹ýÀ´¡£
 151   1         if(receive_wire == 0)               
 152   1            {
 153   2            // Èç¹û½ÓÊÕÏßÊÇ0£¬Ôò½«´Ë±êÖ¾Î»ÖÃ0£¬±íÊ¾´ËÏßÎª0¹ý¡£
 154   2            receive_wire_flag=0;
 155   2            
 156   2            // ½ÓÊÕµ½µÍµçÆ½µÄÊ±¼ä¼ÆÊý£¬´óÓÚ8ms¾ÍÖØÐÂ¼ÆÊý
 157   2            if(++receive_LV_count==120)      
 158   2               {
 159   3               receive_LV_count=0;
 160   3               }
 161   2            }
 162   1         else
 163   1         {
 164   2            if(receive_wire_flag==0)//ËµÃ÷ÓÐÒ»¸öµÍµçÆ½
 165   2            {
 166   3               receive_wire_flag=1;
 167   3      //       one_receive_byte<<=1;
 168   3      
 169   3               if((receive_LV_count>35)&&(receive_LV_count<=80))//µÍµçÆ½³ÖÐøµÄÊ±¼äÐ¡ÓÚ3ms£¬ÔòÎª0
 170   3               {
 171   4                  one_receive_byte<<=1;
 172   4                  one_receive_byte &= 0xfe;
 173   4                  one_receive_byte_count++;
C51 COMPILER V9.51   TIMER                                                                 03/26/2014 20:06:26 PAGE 4   

 174   4                  receive_HV_count=0;
 175   4               }
 176   3               if(receive_LV_count>80)//µÍµçÆ½³ÖÐøµÄÊ±¼ä´óÓÚ4.5ms£¬ÔòÎª1
 177   3               {
 178   4                  one_receive_byte<<=1;
 179   4                  one_receive_byte |= 0x01;
 180   4                  one_receive_byte_count++;
 181   4                  receive_HV_count=0;
 182   4               }
 183   3               else
 184   3               {
 185   4                  receive_HV_count++;  
 186   4               }
 187   3      
 188   3               receive_LV_count=0;
 189   3            }
 190   2            else
 191   2            {
 192   3               receive_HV_count++;
 193   3               if(receive_HV_count>=60)
 194   3               {
 195   4                  one_receive_byte_count=0;
 196   4                  receive_wire_flag=1;
 197   4                  data_count=0;
 198   4               }     
 199   3            }
 200   2         }
 201   1      
 202   1         if(one_receive_byte_count==8)//ËµÃ÷Ò»¸ö×Ö½ÚµÄÊý¾ÝÒÑ¾­½ÓÊÜÍêÈ«
 203   1         {
 204   2            one_receive_byte_count=0;
 205   2            received_data_buffer[data_count]=one_receive_byte;
 206   2            if(data_count==0&&received_data_buffer[0]==CmdHead)
 207   2            {
 208   3               data_count=1;
 209   3            }
 210   2            else if(data_count==1&&received_data_buffer[1]==MyAddress)
 211   2            {
 212   3               data_count=2;
 213   3            }
 214   2            else if(data_count==2)
 215   2            {
 216   3               receive_data_finished_flag=1;
 217   3               data_count=0;
 218   3            }
 219   2            else 
 220   2            {
 221   3               data_count=0;
 222   3            }
 223   2         }
 224   1      
 225   1         if(receive_data_finished_flag==1)   //ËµÃ÷½ÓÊÕµ½ÁËÊý¾Ý£¬¿ªÊ¼´¦Àí
 226   1         {
 227   2            receive_data_finished_flag=0; //Çå½ÓÊÕ±êÖ¾
 228   2            switch(received_data_buffer[2])//½âÎöÖ¸Áî
 229   2            {
 230   3               case ComMode_1://½ÓÊÕµ½µÄÊÇÖ÷»ú·¢ËÍ¹ýÀ´µÄ±àÂë1µÄÐÅºÅ£¬ËµÃ÷Ö÷»úÔÚ3MÄÚ£¬ÊÇÕý³£µÄ
 231   3                  {  
 232   4                  Moto_Vibration();
 233   4                  ComMode_1_Data();
 234   4                  }
 235   3               break;
C51 COMPILER V9.51   TIMER                                                                 03/26/2014 20:06:26 PAGE 5   

 236   3               
 237   3               case ComMode_2:
 238   3                  {
 239   4                  battery_stolen_EN = 1;
 240   4                  Moto_Vibration();          
 241   4                  }
 242   3               break;
 243   3               
 244   3               case ComMode_3:
 245   3                  {
 246   4                  stolen_alarm_flag = 1;
 247   4                  Moto_Vibration();         
 248   4      
 249   4                  raised_alarm_count=0;//Çå±¨¾¯¼ÆÊýÆ÷
 250   4                  raised_alarm_flag=0;//Çå±¨¾¯±êÖ¾
 251   4                  fell_alarm_count=0;//Çå±¨¾¯¼ÆÊýÆ÷
 252   4                  fell_alarm_flag=0;//Çå±¨¾¯±êÖ¾
 253   4                  }
 254   3               break;
 255   3            
 256   3               case ComMode_4://Áô×÷Ì§ÆðÐÅºÅÊ¹ÓÃ
 257   3               {
 258   4                  raised_alarm_flag=1;//Ì§Æð±¨¾¯
 259   4      
 260   4                  stolen_alarm_count=0;//Çå±¨¾¯¼ÆÊýÆ÷
 261   4                  stolen_alarm_flag=0;//Çå±¨¾¯±êÖ¾
 262   4                  fell_alarm_count=0;//Çå±¨¾¯¼ÆÊýÆ÷
 263   4                  fell_alarm_flag=0;//Çå±¨¾¯±êÖ¾
 264   4               }
 265   3               break;
 266   3      
 267   3               case ComMode_5://Áô×÷µ¹µØÐÅºÅÊ¹ÓÃ
 268   3               {
 269   4                  fell_alarm_flag=1;   //µ¹µØ±¨¾¯
 270   4      
 271   4                  stolen_alarm_count=0;//Çå±¨¾¯¼ÆÊýÆ÷
 272   4                  stolen_alarm_flag=0;//Çå±¨¾¯±êÖ¾
 273   4                  raised_alarm_count=0;//Çå±¨¾¯¼ÆÊýÆ÷
 274   4                  raised_alarm_flag=0;//Çå±¨¾¯±êÖ¾
 275   4               }
 276   3               break;
 277   3      
 278   3               case ComMode_6:
 279   3                  {
 280   4                  Host_battery_high_flag = 1;
 281   4                  }
 282   3               break;
 283   3            }
 284   2         }
 285   1      }
 286          
 287          /*--------------------------------------------------
 288             InitTimer()
 289             
 290             ³õÊ¼»¯¶¨Ê±Æ÷T0ºÍT1
 291          ---------------------------------------------------*/
 292          
 293          void InitTimer(const tByte Tick_ms_T0, Tick_us_T1)
 294             {
 295   1         tLong Inc_T0, Inc_T1;
 296   1         tWord timer0_16, timer1_16;
 297   1         
C51 COMPILER V9.51   TIMER                                                                 03/26/2014 20:06:26 PAGE 6   

 298   1         //¼ÆËãTimer0µÄ¼Ä´æÆ÷Öµ
 299   1         Inc_T0 = (tLong)Tick_ms_T0 * (OSC_FREQ/1000) / (tLong)OSC_PER_INST;
 300   1         timer0_16 = (tWord) (65536UL - Inc_T0);
 301   1         timer0_8H = (tByte) (timer0_16 / 256);
 302   1         timer0_8L = (tByte) (timer0_16 % 256);
 303   1         
 304   1         //¼ÆËãTimer1µÄ¼Ä´æÆ÷Öµ
 305   1         Inc_T1 = (tLong)Tick_us_T1 * (OSC_FREQ/1000000) / (tLong)OSC_PER_INST;
 306   1         timer1_16 = (tWord) (65536UL - Inc_T1);
 307   1         timer1_8H = (tByte) (timer1_16 / 256);
 308   1         timer1_8L = (tByte) (timer1_16 % 256);
 309   1         
 310   1         TMOD = 0x11;
 311   1         TH0 = timer0_8H;
 312   1         TL0 = timer0_8L;
 313   1         TH1 = timer1_8H;
 314   1         TL1 = timer1_8L;
 315   1      
 316   1         ET0 = 1;
 317   1         TR0 = 1;
 318   1         ET1 = 1;
 319   1         TR1 = 1;
 320   1         PT1 = 1;       
 321   1         EA = 1;
 322   1         }
 323          
 324          /*---------------------------------------------------------------------
 325             sEos_Go_To_Sleep()
 326             ½«MCU½øÈëÐÝÃß×´Ì¬
 327          ----------------------------------------------------------------------*/
 328          void sEOS_Go_To_Sleep(void)
 329             {
 330   1         PCON |= 0x01;    // Enter idle mode (generic 8051 version)
 331   1         }
 332          
 333          /*---------------------------------------------------
 334             end of file
 335          ----------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    642    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     23      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      9    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
